<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Customer Chat</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    :root{
      --bg:#0b141a;
      --panel:#111b21;
      --panel2:#0f1a20;
      --border:#1f2c33;
      --accent:#25D366;
      --muted:#8696a0;
      --text:#e9edef;
      --bubbleMe:#005c4b;
      --bubbleYou:#202c33;
      --danger:#ff5a5a;
      --warn:#ffcc66;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:linear-gradient(135deg,#0b141a,#0f2a20);color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .app{width:min(1200px,100%);height:min(760px,100%);background:var(--panel);border-radius:18px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.55);display:grid;grid-template-columns:380px 1fr;border:1px solid rgba(255,255,255,.06)}
    .left{border-right:1px solid var(--border);display:flex;flex-direction:column}
    .right{display:flex;flex-direction:column;background:rgba(15,26,32,.95)}
    .topbar{padding:14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
    .badge{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#0ea75a);display:flex;align-items:center;justify-content:center;font-weight:900;color:#04210f}
    .title{line-height:1.1}
    .title b{display:block}
    .title span{font-size:12px;color:var(--muted)}
    .btn{border:0;background:rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.10)}
    .btnPrimary{background:var(--accent);color:#062012;font-weight:900}
    .btnDanger{background:rgba(255,90,90,.12);border:1px solid rgba(255,90,90,.35);color:#ffd0d0}
    .btnDanger:hover{background:rgba(255,90,90,.18)}
    .search{padding:10px 14px;border-bottom:1px solid var(--border);}
    .search input{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.25);color:var(--text);outline:none}
    .list{flex:1;overflow:auto}
    .item{display:flex;gap:10px;padding:12px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.04);position:relative}
    .item:hover{background:rgba(255,255,255,.04)}
    .item.active{background:rgba(37,211,102,.12)}
    .avatar{width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-weight:900}
    .meta{flex:1;min-width:0}
    .meta b{display:block;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta small{color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;margin-top:4px}
    .time{font-size:11px;color:var(--muted)}
    .chip{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.75)}
    .chipOpen{border-color:rgba(37,211,102,.35);background:rgba(37,211,102,.10)}
    .chipClosed{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.06)}
    .chipLabel{border-color:rgba(255,255,255,.14);background:rgba(0,0,0,.18)}
    .chipLabel.new{border-color:rgba(37,211,102,.35);background:rgba(37,211,102,.10)}
    .chipLabel.hot{border-color:rgba(255,90,90,.35);background:rgba(255,90,90,.10)}
    .chipLabel.pending{border-color:rgba(255,204,102,.45);background:rgba(255,204,102,.10)}
    .chipLabel.done{border-color:rgba(200,200,200,.25);background:rgba(255,255,255,.06)}
    .unreadDot{
      min-width:20px;height:20px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:900;
      background:var(--accent);color:#062012;
      padding:0 6px;
      box-shadow:0 6px 18px rgba(37,211,102,.25);
    }
    .chatTop{padding:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .who{display:flex;gap:10px;align-items:center}
    .who .name{line-height:1.1}
    .who .name b{display:block}
    .who .name span{font-size:12px;color:var(--muted)}
    .messages{flex:1;overflow:auto;padding:16px;background:
      radial-gradient(circle at 20% 10%, rgba(37,211,102,.12), transparent 35%),
      radial-gradient(circle at 90% 70%, rgba(37,211,102,.08), transparent 40%),
      rgba(0,0,0,.15);
    }
    .bubble{max-width:75%;padding:10px 12px;border-radius:14px;margin:8px 0;display:inline-block}
    .me{background:var(--bubbleMe);margin-left:auto;border-top-right-radius:6px}
    .you{background:var(--bubbleYou);margin-right:auto;border-top-left-radius:6px}
    .bubble .txt{font-size:14px;white-space:pre-wrap;word-break:break-word}
    .bubble .meta{margin-top:6px;font-size:11px;color:rgba(255,255,255,.65);display:flex;justify-content:flex-end;gap:8px}
    .composer{padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;align-items:center}
    .composer textarea{flex:1;resize:none;height:44px;max-height:120px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.25);color:var(--text);outline:none}
    .quickWrap{padding:10px 12px;border-top:1px solid rgba(255,255,255,.05);display:flex;gap:8px;flex-wrap:wrap}
    .qbtn{font-size:12px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:rgba(255,255,255,.9);cursor:pointer}
    .qbtn:hover{background:rgba(255,255,255,.08)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:min(420px,100%);background:rgba(17,27,33,.98);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.6);padding:16px}
    .card h2{margin:0 0 6px 0}
    .card p{margin:0 0 14px 0;color:var(--muted);font-size:13px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field label{font-size:12px;color:rgba(255,255,255,.75)}
    .field input{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.25);color:var(--text);outline:none}
    select{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.25);color:var(--text);outline:none}
    .link{color:var(--accent);text-decoration:none;font-weight:900}
    @media (max-width:900px){
      .app{grid-template-columns:1fr}
      .right{display:none}
      .right.show{display:flex}
      .left.hide{display:none}
    }
  </style>
</head>
<body>

<div class="app" id="app" style="display:none">
  <div class="left" id="leftPane">
    <div class="topbar">
      <div class="badge">AD</div>
      <div class="title">
        <b id="adminTitle">Admin Dashboard</b>
        <span id="adminSub">Customer Support Chat</span>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <a class="link" href="./index.html">Menu</a>
        <button class="btn btnDanger" id="btnCloseChat">Close</button>
        <button class="btn" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="search">
      <input id="search" placeholder="Cari nama / nomor / status / label..." />
    </div>

    <div class="list" id="chatList"></div>
  </div>

  <div class="right" id="rightPane">
    <div class="chatTop">
      <div class="who">
        <div class="avatar" id="chatAvatar">?</div>
        <div class="name">
          <b id="chatName">Pilih customer</b>
          <span id="chatSub">‚Äî</span>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <select id="labelSelect" title="Label customer">
          <option value="NEW">NEW</option>
          <option value="HOT">HOT</option>
          <option value="PENDING">PENDING</option>
          <option value="DONE">DONE</option>
        </select>

        <button class="btn" id="btnBack" style="display:none">‚Üê Kembali</button>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="quickWrap" id="quickWrap">
      <button class="qbtn" data-q="Halo kak üëã Ada yang bisa kami bantu?">Halo kak üëã</button>
      <button class="qbtn" data-q="Baik kak, kami cek dulu ya üôè">Kami cek dulu üôè</button>
      <button class="qbtn" data-q="Siap kak, kami proses sekarang ya ‚úÖ">Kami proses ‚úÖ</button>
      <button class="qbtn" data-q="Terima kasih kak üôè Jika ada pertanyaan lain, chat aja ya üòä">Terima kasih üôè</button>
    </div>

    <div class="composer">
      <textarea id="msg" placeholder="Balas customer..."></textarea>
      <button class="btn btnPrimary" id="send">Kirim</button>
    </div>
  </div>
</div>

<div class="overlay" id="loginWrap">
  <div class="card">
    <h2>Admin Login üîê</h2>

    <div id="installWrap" style="display:none;margin-top:10px;background:rgba(37,211,102,.12);border:1px solid rgba(37,211,102,.35);padding:10px;border-radius:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:800">Pasang Dashboard Admin üì≤</div>
          <small style="color:#a7c8b4">Biar admin enak, tinggal buka dari ikon HP. Nggak perlu install Playstore.</small>
        </div>
        <button id="installBtn" style="white-space:nowrap">Pasang</button>
      </div>
    </div>

    <p>Masukkan PIN Admin untuk akses dashboard.</p>

    <div class="field">
      <label>PIN Admin</label>
      <input id="pinInput" placeholder="contoh: 123456" type="password" />
    </div>

    <button class="btn btnPrimary" id="btnLogin" style="width:100%">Masuk</button>
    <p style="margin-top:10px;color:var(--muted);font-size:12px">
      PIN disimpan di Firestore: <b>settings/admin</b>
    </p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, addDoc, collection, query,
    orderBy, onSnapshot, serverTimestamp, limit
  } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  // ====== ISI CONFIG FIREBASE LU ======
  const firebaseConfig = {
    apiKey: "ISI_API_KEY",
    authDomain: "ISI_AUTH_DOMAIN",
    projectId: "ISI_PROJECT_ID",
    storageBucket: "ISI_STORAGE_BUCKET",
    messagingSenderId: "ISI_SENDER_ID",
    appId: "ISI_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const appEl = document.getElementById("app");
  const loginWrap = document.getElementById("loginWrap");
  const pinInput = document.getElementById("pinInput");
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  const chatList = document.getElementById("chatList");
  const search = document.getElementById("search");
  const messagesEl = document.getElementById("messages");
  const msg = document.getElementById("msg");
  const send = document.getElementById("send");

  const chatName = document.getElementById("chatName");
  const chatSub = document.getElementById("chatSub");
  const chatAvatar = document.getElementById("chatAvatar");
  const adminTitle = document.getElementById("adminTitle");
  const adminSub = document.getElementById("adminSub");

  const btnCloseChat = document.getElementById("btnCloseChat");
  const btnBack = document.getElementById("btnBack");
  const leftPane = document.getElementById("leftPane");
  const rightPane = document.getElementById("rightPane");

  const labelSelect = document.getElementById("labelSelect");
  const quickWrap = document.getElementById("quickWrap");

  let activeChat = null;
  let unsubMessages = null;
  let unsubChats = null;
  let chatsCache = [];
  let adminSession = null;

  // ---- SOUND NOTIF
  let lastNotifAt = 0;
  function playNotif(){
    try{
      const now = Date.now();
      if(now - lastNotifAt < 900) return;
      lastNotifAt = now;

      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.05;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 140);
    }catch(e){}
  }

  const escapeHtml = (s) => (s || "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
  const initials = (name) => (name || "?").trim().split(/\s+/).slice(0,2).map(x=>x[0]?.toUpperCase()).join("");
  const formatTime = (ts) => {
    try{ if(!ts) return ""; return ts.toDate().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}); }
    catch(e){ return ""; }
  };

  function showMobileChat(){
    if(window.innerWidth <= 900){
      leftPane.classList.add("hide");
      rightPane.classList.add("show");
      btnBack.style.display = "inline-block";
    }
  }
  function showMobileList(){
    if(window.innerWidth <= 900){
      leftPane.classList.remove("hide");
      rightPane.classList.remove("show");
      btnBack.style.display = "none";
    }
  }

  function saveAdminSession(){
    localStorage.setItem("cs_admin_session", JSON.stringify(adminSession));
  }
  function loadAdminSession(){
    try{ return JSON.parse(localStorage.getItem("cs_admin_session")); }catch(e){ return null; }
  }
  function clearAdminSession(){
    localStorage.removeItem("cs_admin_session");
  }

  async function getAdminSettings(){
    const snap = await getDoc(doc(db, "settings", "admin"));
    if(!snap.exists()){
      throw new Error("settings/admin belum ada. Buat dulu di Firestore.");
    }
    return snap.data();
  }

  async function doLogin(pin){
    const settings = await getAdminSettings();
    const realPin = String(settings.adminPin || "");
    const inputPin = String(pin || "");

    if(!realPin) throw new Error("adminPin kosong di settings/admin");
    if(inputPin !== realPin) throw new Error("PIN salah ‚ùå");

    adminSession = {
      ok: true,
      adminName: settings.adminName || "Admin CS",
      loggedAt: Date.now()
    };
    saveAdminSession();

    adminTitle.textContent = adminSession.adminName + " ‚Ä¢ Dashboard";
    loginWrap.style.display = "none";
    appEl.style.display = "grid";

    listenChats();
  }

  function labelClass(label){
    const l = String(label || "NEW").toLowerCase();
    if(l === "hot") return "chipLabel hot";
    if(l === "pending") return "chipLabel pending";
    if(l === "done") return "chipLabel done";
    return "chipLabel new";
  }

  function updateUnreadHeader(chats){
    const total = chats.reduce((acc,c)=>acc + (c.unreadAdmin||0),0);
    adminSub.textContent = total > 0 ? `Customer Support Chat ‚Ä¢ Unread: ${total}` : "Customer Support Chat";
  }

  function renderChatList(chats){
    chatsCache = chats;
    const q = (search.value || "").toLowerCase();
    chatList.innerHTML = "";

    const filtered = chats.filter(c => {
      const name = (c.customerName || "").toLowerCase();
      const phone = (c.customerPhone || "").toLowerCase();
      const status = (c.status || "").toLowerCase();
      const label = (c.label || "NEW").toLowerCase();
      return (name + " " + phone + " " + status + " " + label).includes(q);
    });

    if(filtered.length === 0){
      chatList.innerHTML = `<div style="padding:16px;color:var(--muted)">Belum ada chat masuk.</div>`;
      return;
    }

    for(const c of filtered){
      const status = (c.status || "open").toLowerCase();
      const chipClass = status === "closed" ? "chip chipClosed" : "chip chipOpen";
      const lbl = (c.label || "NEW").toUpperCase();
      const unread = typeof c.unreadAdmin === "number" ? c.unreadAdmin : 0;

      const item = document.createElement("div");
      item.className = "item" + (activeChat?.chatId === c.chatId ? " active" : "");
      item.innerHTML = `
        <div class="avatar">${escapeHtml(initials(c.customerName || c.customerPhone))}</div>
        <div class="meta">
          <b>${escapeHtml(c.customerName || "Customer")}</b>
          <small>${escapeHtml(c.lastMessage || "‚Äî")}</small>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="time">${c.lastMessageAt ? formatTime(c.lastMessageAt) : ""}</div>
          <div style="display:flex;gap:6px;align-items:center">
            <div class="chip ${chipClass}">${escapeHtml(status)}</div>
            <div class="chip ${labelClass(lbl)}">${escapeHtml(lbl)}</div>
            ${unread > 0 ? `<div class="unreadDot">${unread}</div>` : ``}
          </div>
        </div>
      `;
      item.onclick = () => openChat(c);
      chatList.appendChild(item);
    }

    updateUnreadHeader(chats);
  }

  function renderMessages(list){
    messagesEl.innerHTML = "";
    for(const m of list){
      const mine = m.role === "admin";
      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.justifyContent = mine ? "flex-end" : "flex-start";

      const b = document.createElement("div");
      b.className = "bubble " + (mine ? "me" : "you");
      b.innerHTML = `
        <div class="txt">${escapeHtml(m.text)}</div>
        <div class="meta"><span>${formatTime(m.createdAt)}</span></div>
      `;
      wrap.appendChild(b);
      messagesEl.appendChild(wrap);
    }
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function markRead(chatId){
    await setDoc(doc(db, "supportChats", chatId), { unreadAdmin: 0 }, { merge:true });
  }

  function openChat(c){
    activeChat = {
      chatId: c.chatId,
      customerPhone: c.customerPhone,
      customerName: c.customerName
    };

    const label = (c.label || "NEW").toUpperCase();
    labelSelect.value = label;

    chatName.textContent = c.customerName || "Customer";
    chatSub.textContent = `${c.customerPhone} ‚Ä¢ status: ${c.status || "open"} ‚Ä¢ label: ${label}`;
    chatAvatar.textContent = initials(c.customerName || c.customerPhone);

    showMobileChat();

    markRead(c.chatId);

    if(unsubMessages) unsubMessages();

    const mq = query(
      collection(db, "supportChats", c.chatId, "messages"),
      orderBy("createdAt", "asc"),
      limit(400)
    );

    unsubMessages = onSnapshot(mq, (snap) => {
      const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderMessages(list);
      renderChatList(chatsCache);
    });
  }

  async function sendMessage(){
    if(!activeChat) return alert("Pilih chat customer dulu bro üòÑ");
    const text = (msg.value || "").trim();
    if(!text) return;

    await addDoc(collection(db, "supportChats", activeChat.chatId, "messages"), {
      role: "admin",
      text,
      createdAt: serverTimestamp()
    });

    msg.value = "";
  }

  async function closeChat(){
    if(!activeChat) return alert("Pilih chat dulu.");
    await setDoc(doc(db, "supportChats", activeChat.chatId), {
      status: "closed",
      updatedAt: serverTimestamp()
    }, { merge:true });
    alert("Chat ditutup ‚úÖ");
  }

  async function setLabel(newLabel){
    if(!activeChat) return;
    const label = String(newLabel || "NEW").toUpperCase();

    await setDoc(doc(db, "supportChats", activeChat.chatId), {
      label,
      updatedAt: serverTimestamp()
    }, { merge:true });

    chatSub.textContent = `${activeChat.customerPhone} ‚Ä¢ status: open ‚Ä¢ label: ${label}`;
  }

  function listenChats(){
    if(unsubChats) unsubChats();

    const cq = query(
      collection(db, "supportChats"),
      orderBy("updatedAt", "desc"),
      limit(120)
    );

    let lastSeen = new Map(); // chatId -> lastMessageAt millis

    unsubChats = onSnapshot(cq, (snap) => {
      const chats = snap.docs.map(d => d.data());

      // notif if new customer message arrives (lastMessageAt changes)
      for(const c of chats){
        const t = c.lastMessageAt?.toMillis?.() || 0;
        const prev = lastSeen.get(c.chatId) || 0;
        if(t > prev){
          lastSeen.set(c.chatId, t);
          if(c.lastSender === "customer" && activeChat?.chatId !== c.chatId){
            playNotif();
          }
        }
      }

      renderChatList(chats);
    });
  }

  btnLogin.onclick = async () => {
    try{
      await doLogin(pinInput.value);
    }catch(err){
      alert(err.message || "Gagal login");
    }
  };

  btnLogout.onclick = () => {
    if(confirm("Logout admin?")){
      if(unsubMessages) unsubMessages();
      if(unsubChats) unsubChats();
      clearAdminSession();
      location.reload();
    }
  };

  send.onclick = sendMessage;
  msg.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  btnCloseChat.onclick = closeChat;
  btnBack.onclick = () => showMobileList();
  search.addEventListener("input", () => renderChatList(chatsCache));

  quickWrap.addEventListener("click", (e) => {
    const btn = e.target.closest(".qbtn");
    if(!btn) return;
    const text = btn.getAttribute("data-q") || "";
    if(!text) return;

    msg.value = text;
    msg.focus();
  });

  labelSelect.addEventListener("change", () => {
    setLabel(labelSelect.value);
  });

  const sess = loadAdminSession();
  if(sess?.ok){
    adminSession = sess;
    adminTitle.textContent = adminSession.adminName + " ‚Ä¢ Dashboard";
    loginWrap.style.display = "none";
    appEl.style.display = "grid";
    listenChats();
  }

  // ===== PWA: Install to Home Screen (Admin) =====
  let deferredPrompt = null;
  const installWrap = document.getElementById("installWrap");
  const installBtn = document.getElementById("installBtn");

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installWrap.style.display = "block";
  });

  installBtn?.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    installWrap.style.display = "none";
    console.log("PWA install outcome:", outcome);
  });

  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        await navigator.serviceWorker.register("./sw.js");
        console.log("Service Worker registered");
      } catch (err) {
        console.warn("Service Worker registration failed:", err);
      }
    });
  }

</script>
</body>
</html>
